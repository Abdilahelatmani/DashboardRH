<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard RH - Analyse des Salaires</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f23;
            color: #fff;
            overflow-x: hidden;
        }

        /* Gradient Backgrounds */
        .gradient-bg {
            position: fixed;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            z-index: -1;
            background: linear-gradient(45deg, #0f0f23, #1a1a3e, #2d1b69, #0f0f23);
            animation: gradient-shift 15s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        /* Header */
        .header {
            background: rgba(26, 26, 62, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* File Upload Section */
        .upload-section {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            text-align: center;
        }

        .upload-area {
            background: rgba(26, 26, 62, 0.6);
            border: 2px dashed rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 60px 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .upload-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        #fileInput {
            display: none;
        }

        /* Filters Section */
        .filters-section {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            display: none;
        }

        .filters-container {
            background: rgba(26, 26, 62, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 15px;
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .reset-filters {
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .reset-filters:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none;
        }

        /* KPI Cards */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: rgba(26, 26, 62, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .kpi-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-label {
            font-size: 14px;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-change {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .kpi-change.negative {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: rgba(26, 26, 62, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px rgba(102, 126, 234, 0.2);
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .chart-actions {
            display: flex;
            gap: 10px;
        }

        .chart-action {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chart-action:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Data Table */
        .table-container {
            background: rgba(26, 26, 62, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.2);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .search-box {
            padding: 10px 20px;
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #fff;
            width: 300px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(102, 126, 234, 0.2);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            color: #e0e0e0;
        }

        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 20px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filter-group {
                width: 100%;
            }

            .search-box {
                width: 100%;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(26, 26, 62, 0.6);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animated {
            animation: fadeIn 0.6s ease-out;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            max-width: 400px;
            max-height: 200px;
            overflow: auto;
            font-size: 12px;
            z-index: 10000;
            border: 1px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">Dashboard RH Analytics</h1>
            <div class="header-actions">
                <span id="fileName" style="margin-right: 20px; opacity: 0.7;"></span>
                <span id="userInfo" style="margin-right: 20px; color: #a0a0a0; font-size: 14px;"></span>
                <button onclick="location.reload()" style="padding: 8px 20px; background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: #667eea; cursor: pointer; margin-right: 10px;">Nouveau fichier</button>
                <button id="logoutBtn" style="padding: 8px 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 8px; color: #e74c3c; cursor: pointer; transition: all 0.3s ease;">🚪 Déconnexion</button>
            </div>
        </div>
    </header>

    <!-- File Upload Section -->
    <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📊</div>
            <div class="upload-text">Glissez et déposez votre fichier Excel ici</div>
            <div class="upload-subtext">ou cliquez pour sélectionner un fichier</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls" />
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" id="filtersSection">
        <div class="filters-container">
            <div class="filter-group">
                <label class="filter-label">Année</label>
                <select class="filter-select" id="yearFilter">
                    <option value="">Toutes les années</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Société</label>
                <select class="filter-select" id="societeFilter">
                    <option value="">Toutes les sociétés</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Département</label>
                <select class="filter-select" id="departementFilter">
                    <option value="">Tous les départements</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Service</label>
                <select class="filter-select" id="serviceFilter">
                    <option value="">Tous les services</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Catégorie</label>
                <select class="filter-select" id="categorieFilter">
                    <option value="">Toutes les catégories</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Shift</label>
                <select class="filter-select" id="shiftFilter">
                    <option value="">Tous les shifts</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Sexe</label>
                <select class="filter-select" id="sexeFilter">
                    <option value="">Tous</option>
                    <option value="Homme">Homme</option>
                    <option value="Femme">Femme</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Nationalité</label>
                <select class="filter-select" id="nationaliteFilter">
                    <option value="">Toutes les nationalités</option>
                </select>
            </div>
            <button class="reset-filters" onclick="resetFilters()">Réinitialiser</button>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- KPI Cards -->
        <div class="kpi-section">
            <div class="kpi-card animated">
                <div class="kpi-icon">👥</div>
                <div class="kpi-value" id="totalEmployees">0</div>
                <div class="kpi-label">Effectif Total</div>
            </div>
            <div class="kpi-card animated">
                <div class="kpi-icon">💰</div>
                <div class="kpi-value" id="totalSalary">0 €</div>
                <div class="kpi-label">Masse Salariale</div>
            </div>
            <div class="kpi-card animated">
                <div class="kpi-icon">👩</div>
                <div class="kpi-value" id="femalePercentage">0%</div>
                <div class="kpi-label">Taux Sexe</div>
            </div>
            <div class="kpi-card animated">
                <div class="kpi-icon">💼</div>
                <div class="kpi-value" id="avgSalary">0 €</div>
                <div class="kpi-label">Salaire Moyen Mensuel</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Monthly Salary Chart -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Salaires par Mois</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="monthlySalaryChart"></canvas>
                </div>
            </div>

            <!-- Department Salary Distribution -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Salaire par Département</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="departmentSalaryChart"></canvas>
                </div>
            </div>

            <!-- Category Salary Distribution -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Salaire par Catégorie</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categorySalaryChart"></canvas>
                </div>
            </div>

            <!-- Salary by Nationality Chart -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Salaire par Nationalité</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="nationalitySalaryChart"></canvas>
                </div>
            </div>

            <!-- Top Paid Services -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Top 10 Services par Salaire</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="topServicesSalaryChart"></canvas>
                </div>
            </div>

            <!-- Salary Range Distribution -->
            <!-- <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition des Salaires</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="salaryRangeChart"></canvas>
                </div>
            </div> -->

            <!-- Répartition par Sexe -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition par Sexe</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="sexeDistributionChart"></canvas>
                </div>
            </div>

            <!-- Personnel by Nationality Distribution -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition du Personnel par Nationalité</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="nationalityPersonnelChart"></canvas>
                </div>
            </div>

            <!-- Répartition par Shift -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition par Shift</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="shiftDistributionChart"></canvas>
                </div>
            </div>

            <!-- Répartition par Département -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition par Département</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="departmentDistributionChart"></canvas>
                </div>
            </div>

            <!-- Répartition par Service -->
            <div class="chart-container animated">
                <div class="chart-header">
                    <h3 class="chart-title">Répartition par Service</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="serviceDistributionChart"></canvas>
                </div>
            </div>

            <!-- Annual Salary Trend -->
            <div class="chart-container full-width animated">
                <div class="chart-header">
                    <!-- <h3 class="chart-title">Évolution Annuelle des Salaires</h3> -->
                     <h3 class="chart-title">Évolution Annuelle: Salaires & Personnel</h3>

                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="annualSalaryTrendChart"></canvas>
                </div>
            </div>

            <!-- Personnel Evolution Chart - ADD THIS -->
            <!-- <div class="chart-container full-width animated">
                <div class="chart-header">
                    <h3 class="chart-title">Évolution du Personnel par Année</h3>
                    <div class="chart-actions">
                        <button class="chart-action" title="Exporter">📊</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="personnelEvolutionChart"></canvas>
                </div>
            </div> -->

        </div>

        <!-- Data Table -->
        <div class="table-container animated">
            <div class="table-header">
                <h3 class="chart-title">Détail des Employés</h3>
                <input type="text" class="search-box" id="searchBox" placeholder="Rechercher...">
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th class="fixed-column">Matricule</th>
                            <th class="fixed-column">Nom & Prénom</th>
                            <th>Société</th>
                            <th>Département</th>
                            <th>Catégorie</th>
                            <th>Service</th>
                            <th>Shift</th>
                            
                            <!-- Colonnes pour les mois -->
                            <th class="month-column">Janvier</th>
                            <th class="month-column">Février</th>
                            <th class="month-column">Mars</th>
                            <th class="month-column">Avril</th>
                            <th class="month-column">Mai</th>
                            <th class="month-column">Juin</th>
                            <th class="month-column">Juillet</th>
                            <th class="month-column">Août</th>
                            <th class="month-column">Septembre</th>
                            <th class="month-column">Octobre</th>
                            <th class="month-column">Novembre</th>
                            <th class="month-column">Décembre</th>         
                            <!-- Colonnes pour le total et l'année -->
                            <th class="total-column">Total</th>
                            <th class="year-column">Année</th>

                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <strong>Debug Console</strong>
        <div id="debugOutput"></div>
    </div>

    <script>
        // Global variables
        let excelData = [];
        let filteredData = [];
        let charts = {};

// Add this at the beginning of your script section, after the global variables
// Session management and security
window.addEventListener('load', function() {
    // Check if user is logged in
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        alert('Accès non autorisé. Redirection vers la page de connexion...');
        window.location.href = 'index.html'; // Change to your login page name
        return;
    }
    
    // Display user info
    const username = sessionStorage.getItem('username') || 'Utilisateur';
    const loginTime = sessionStorage.getItem('loginTime');
    const userInfo = document.getElementById('userInfo');
    
    if (userInfo) {
        const loginDate = new Date(loginTime);
        const timeString = loginDate.toLocaleTimeString('fr-FR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        userInfo.textContent = `👤 ${username} • Connecté à ${timeString}`;
    }
});

// Logout functionality
function logout() {
    // Show confirmation dialog
    if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
        // Clear all session data
        sessionStorage.clear();
        
        // Optional: Clear remembered username if you want
        // localStorage.removeItem('rememberedUsername');
        
        // Show logout message
        alert('Déconnexion réussie !');
        
        // Redirect to login page
        window.location.href = 'index.html'; // Change to your login page name
    }
}

// Add logout button event listener
document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
        
        // Add hover effects
        logoutBtn.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(231, 76, 60, 0.3)';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(231, 76, 60, 0.3)';
        });
        
        logoutBtn.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(231, 76, 60, 0.2)';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    }
});

// Optional: Auto-logout after inactivity (30 minutes)
let inactivityTimer;
const INACTIVITY_TIME = 30 * 60 * 1000; // 30 minutes

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert('Session expirée en raison d\'inactivité. Vous allez être déconnecté.');
        logout();
    }, INACTIVITY_TIME);
}

// Track user activity
['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
});

// Initialize inactivity timer
resetInactivityTimer();



        // CORRECTION DU PROBLÈME DE CALCUL DES SALAIRES
        function cleanNumericValue(value) {
            // Si la valeur est déjà un nombre, la retourner directement
            if (typeof value === 'number') {
                return value;
            }
            
            // Si c'est une chaîne, effectuer le nettoyage
            if (typeof value === 'string') {
                // Supprimer les espaces, les tirets et les caractères non numériques
                let cleanedValue = value.replace(/\s+/g, '').replace(/-/g, '');
                
                // Remplacer les virgules par des points pour les décimales
                cleanedValue = cleanedValue.replace(/,/g, '.');
                
                // Supprimer tous les caractères non numériques sauf le point
                cleanedValue = cleanedValue.replace(/[^\d.]/g, '');
                
                // Convertir en nombre
                const numValue = parseFloat(cleanedValue);
                
                // Si la conversion échoue, retourner 0 et logguer un avertissement
                if (isNaN(numValue)) {
                    console.warn(`Valeur non numérique détectée: "${value}" -> convertie en 0`);
                    return 0;
                }
                
                return numValue;
            }
            
            // Pour tout autre type (comme null ou undefined), retourner 0
            return 0;
        }

        // Fonction pour obtenir les employés uniques
        function getUniqueEmployees(data) {
            const uniqueEmployees = new Map();
            data.forEach(row => {
                const id = row._id;
                if (!uniqueEmployees.has(id)) {
                    uniqueEmployees.set(id, row);
                }
            });
            return Array.from(uniqueEmployees.values());
        }

        // Chart.js default configuration
        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = 'rgba(102, 126, 234, 0.2)';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';

        // Initialize file upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Handle file upload
        function handleFile(file) {
            const reader = new FileReader();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Process data
                processData();
                
                // Show dashboard
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('filtersSection').style.display = 'block';
                document.getElementById('dashboardContainer').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
                // Initialize filters
                initializeFilters();
                
                // Update dashboard
                updateDashboard();
            };

            reader.readAsArrayBuffer(file);
        }

        // Process Excel data
        function processData() {
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            // Log pour vérifier les données
            if (excelData.length > 0) {
                console.log("Première ligne des données:", excelData[0]);
            }
            
            excelData = excelData.map(row => {
                let totalSalary = 0;
                
                // 1. Ajouter les salaires mensuels avec nettoyage
                months.forEach(month => {
                    const value = cleanNumericValue(row[month]);
                    totalSalary += value;
                });
                
                // 2. Vérifier s'il existe une colonne "Total" dans le fichier Excel
                if (row['Total'] !== undefined) {
                    const totalValue = cleanNumericValue(row['Total']);
                    // Utiliser la valeur de "Total" si elle est valide
                    if (totalValue > 0) {
                        row._totalSalary = totalValue;
                    } else {
                        row._totalSalary = totalSalary;
                    }
                } else {
                    row._totalSalary = totalSalary;
                }
                
                // 3. Créer un identifiant unique pour chaque employé
                row._id = `${row['Matricule']}_${row['Nom & Prénom']}`;
                
                return row;
            });
            
            filteredData = [...excelData];
            
            // Log pour vérifier le calcul des salaires
            if (excelData.length > 0) {
                console.log("Première ligne après traitement:", excelData[0]);
            }
        }

        // Initialize filters
        function initializeFilters() {
            // Get unique values for each filter
            const years = [...new Set(excelData.map(row => row['Année']))].filter(Boolean).sort();
            const societes = [...new Set(excelData.map(row => row['Société']))].filter(Boolean).sort();
            const departements = [...new Set(excelData.map(row => row['Département']))].filter(Boolean).sort();
            const services = [...new Set(excelData.map(row => row['Service / Fonction']))].filter(Boolean).sort();
            const categories = [...new Set(excelData.map(row => row['Catégorie']))].filter(Boolean).sort();
            const shifts = [...new Set(excelData.map(row => row['Shift']))].filter(Boolean).sort();
            const nationalites = [...new Set(excelData.map(row => row['Nationalité']))].filter(Boolean).sort(); // ADD THIS LINE

            // Populate filter dropdowns
            populateFilter('yearFilter', years);
            populateFilter('societeFilter', societes);
            populateFilter('departementFilter', departements);
            populateFilter('serviceFilter', services);
            populateFilter('categorieFilter', categories);
            populateFilter('shiftFilter', shifts);
            populateFilter('nationaliteFilter', nationalites);

            // Add event listeners
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', applyFilters);
            });
            
            // Ajouter l'écouteur d'événement pour le département
            document.getElementById('departementFilter').addEventListener('change', function() {
                updateServiceFilter();
                applyFilters();
            });
        }

        // Populate filter dropdown
        function populateFilter(filterId, values) {
            const select = document.getElementById(filterId);
            // Ne réinitialiser que si le filtre n'a pas d'options
            if (select.options.length <= 1) {
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            }
        }

        // Update service filter based on department
        function updateServiceFilter() {
            const departementFilter = document.getElementById('departementFilter').value;
            const serviceFilter = document.getElementById('serviceFilter');
            
            // Sauvegarder la valeur sélectionnée
            const currentValue = serviceFilter.value;
            
            // Réinitialiser le filtre
            serviceFilter.innerHTML = '<option value="">Tous les services</option>';
            
            if (departementFilter) {
                // Récupérer les services du département sélectionné
                const services = [...new Set(excelData
                    .filter(row => row['Département'] === departementFilter)
                    .map(row => row['Service / Fonction'])
                    .filter(Boolean)
                    .sort())];
                
                // Ajouter les options
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service;
                    option.textContent = service;
                    serviceFilter.appendChild(option);
                });
            }
            
            // Restaurer la sélection si possible
            if (Array.from(serviceFilter.options).some(opt => opt.value === currentValue)) {
                serviceFilter.value = currentValue;
            }
        }

        // Apply filters
        function applyFilters() {
            const yearFilter = document.getElementById('yearFilter').value;
            const societeFilter = document.getElementById('societeFilter').value;
            const departementFilter = document.getElementById('departementFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const categorieFilter = document.getElementById('categorieFilter').value;
            const shiftFilter = document.getElementById('shiftFilter').value;
            const sexeFilter = document.getElementById('sexeFilter').value;
            const nationaliteFilter = document.getElementById('nationaliteFilter').value; // ADD THIS LINE

            filteredData = excelData.filter(row => {
                return (!yearFilter || row['Année'] == yearFilter) &&
                       (!societeFilter || row['Société'] == societeFilter) &&
                       (!departementFilter || row['Département'] == departementFilter) &&
                       (!serviceFilter || row['Service / Fonction'] == serviceFilter) &&
                       (!categorieFilter || row['Catégorie'] == categorieFilter) &&
                       (!shiftFilter || row['Shift'] == shiftFilter) &&
                       (!sexeFilter || row['Sexe'] == sexeFilter)&&
                       (!nationaliteFilter || row['Nationalité'] == nationaliteFilter);
            });

            updateDashboard();
        }

        // Reset filters
        function resetFilters() {
            document.querySelectorAll('.filter-select').forEach(select => {
                select.value = '';
            });
            filteredData = [...excelData];
            updateDashboard();
        }

        // Update dashboard with filtered data
        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTable();
        }

        // Update KPI cards
        function updateKPIs() {
            // Total employees sans doublons (basé sur l'identifiant unique)
            const uniqueEmployees = getUniqueEmployees(filteredData);
            
            document.getElementById('totalEmployees').textContent = uniqueEmployees.length;

            // Total salaire (somme de tous les salaires totaux)
            const totalSalary = filteredData.reduce((sum, row) => sum + (row._totalSalary || 0), 0);
            document.getElementById('totalSalary').textContent = formatCurrency(totalSalary);

            // Calcul des taux homme/femme
            const femaleCount = uniqueEmployees.filter(row => row['Sexe'] === 'Femme').length;
            const maleCount = uniqueEmployees.filter(row => row['Sexe'] === 'Homme').length;
            const totalCount = femaleCount + maleCount;

            const femalePercentage = totalCount > 0 ? 
                (femaleCount / totalCount * 100).toFixed(1) : 0;
            
            const malePercentage = totalCount > 0 ? 
                (maleCount / totalCount * 100).toFixed(1) : 0;

            // Mise à jour de l'affichage
            document.getElementById('femalePercentage').innerHTML = 
                `<span style="color: #ec4899">F: ${femalePercentage}%</span><br>
                 <span style="color: #3b82f6">H: ${malePercentage}%</span>`;
            

// Sum all annual salaries and divide by number of employees, then by 12 for monthly
const totalAnnualSalary = filteredData.reduce((sum, row) => sum + (row._totalSalary || 0), 0);
const avgMonthlySalary = uniqueEmployees.length > 0 ? 
    totalAnnualSalary / uniqueEmployees.length / 12 : 0;

document.getElementById('avgSalary').textContent = formatCurrency(avgMonthlySalary);

            // // Average salary - CORRECTION: diviser par 12 pour obtenir la moyenne mensuelle
            // const totalMonthlySalary = filteredData.reduce((sum, row) => {
            //     return sum + (row._totalSalary || 0) / 12;
            // }, 0);
            
            // const avgSalary = filteredData.length > 0 ? totalMonthlySalary / filteredData.length : 0;
            // document.getElementById('avgSalary').textContent = formatCurrency(avgSalary);
        }

        // Update all charts
        function updateCharts() {
            updateMonthlySalaryChart();
            updateDepartmentSalaryChart();
            updateCategorySalaryChart();
            updateTopServicesSalaryChart();
            //updateSalaryRangeChart();
            updateAnnualSalaryTrendChart();
            updateSexeDistributionChart();
            updateShiftDistributionChart();
            updateDepartmentDistributionChart();
            updateServiceDistributionChart(); // Nouveau graphique
            //updatePersonnelEvolutionChart(); // ADD THIS LINE
            updateNationalitySalaryChart(); // ADD THIS LINE
            updateNationalityPersonnelChart(); // ADD THIS LINE
        }


// Nationality Salary Chart
function updateNationalitySalaryChart() {
    const ctx = document.getElementById('nationalitySalaryChart').getContext('2d');
    
    const nationalitySalary = {};
    
    filteredData.forEach(row => {
        const nationality = row['Nationalité'] || 'Non spécifié';
        if (!nationalitySalary[nationality]) {
            nationalitySalary[nationality] = 0;
        }
        nationalitySalary[nationality] += (row._totalSalary || 0);
    });

    // Sort by total salary and take top 10
    const sortedNationalities = Object.entries(nationalitySalary)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    if (charts.nationalitySalary) {
        charts.nationalitySalary.destroy();
    }

    charts.nationalitySalary = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedNationalities.map(n => n[0]),
            datasets: [{
                label: 'Salaire Total',
                data: sortedNationalities.map(n => n[1]),
                backgroundColor: 'rgba(255, 193, 7, 0.6)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 193, 7, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Salaire total: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 193, 7, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Nationality Personnel Distribution Chart
function updateNationalityPersonnelChart() {
    const ctx = document.getElementById('nationalityPersonnelChart').getContext('2d');
    const uniqueEmployees = getUniqueEmployees(filteredData);
    
    const nationalityCounts = {};
    
    uniqueEmployees.forEach(row => {
        const nationality = row['Nationalité'] || 'Non spécifié';
        nationalityCounts[nationality] = (nationalityCounts[nationality] || 0) + 1;
    });

    // Sort by count and take top 8 for pie chart readability
    const sortedNationalities = Object.entries(nationalityCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    if (charts.nationalityPersonnel) {
        charts.nationalityPersonnel.destroy();
    }

    const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(199, 199, 199, 0.8)',
        'rgba(83, 102, 255, 0.8)'
    ];

    charts.nationalityPersonnel = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: sortedNationalities.map(n => n[0]),
            datasets: [{
                data: sortedNationalities.map(n => n[1]),
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = sortedNationalities.reduce((sum, n) => sum + n[1], 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


// Personnel Evolution Chart - NEW FUNCTION
// function updatePersonnelEvolutionChart() {
//     const ctx = document.getElementById('personnelEvolutionChart').getContext('2d');
    
//     // Group data by year and get unique employees for each year
//     const yearlyPersonnelData = {};
    
//     filteredData.forEach(row => {
//         const year = row['Année'] || 'Non spécifié';
//         if (!yearlyPersonnelData[year]) {
//             yearlyPersonnelData[year] = new Set();
//         }
//         // Use unique identifier to avoid duplicates
//         const employeeId = row._id || `${row['Matricule']}_${row['Nom & Prénom']}`;
//         yearlyPersonnelData[year].add(employeeId);
//     });

//     // Convert to arrays and sort years
//     const years = Object.keys(yearlyPersonnelData).sort();
//     const personnelCounts = years.map(year => yearlyPersonnelData[year].size);

//     if (charts.personnelEvolution) {
//         charts.personnelEvolution.destroy();
//     }

//     charts.personnelEvolution = new Chart(ctx, {
//         type: 'line',
//         data: {
//             labels: years,
//             datasets: [{
//                 label: 'Nombre d\'employés',
//                 data: personnelCounts,
//                 borderColor: '#10b981',
//                 backgroundColor: 'rgba(16, 185, 129, 0.1)',
//                 borderWidth: 3,
//                 tension: 0.3,
//                 fill: true,
//                 pointBackgroundColor: '#fff',
//                 pointBorderColor: '#10b981',
//                 pointRadius: 6,
//                 pointHoverRadius: 8,
//                 pointBorderWidth: 2
//             }]
//         },
//         options: {
//             responsive: true,
//             maintainAspectRatio: false,
//             plugins: {
//                 legend: {
//                     display: false
//                 },
//                 tooltip: {
//                     backgroundColor: 'rgba(26, 26, 62, 0.9)',
//                     titleColor: '#fff',
//                     bodyColor: '#fff',
//                     borderColor: 'rgba(16, 185, 129, 0.5)',
//                     borderWidth: 1,
//                     padding: 12,
//                     callbacks: {
//                         label: function(context) {
//                             return `Effectif: ${context.parsed.y} employés`;
//                         }
//                     }
//                 }
//             },
//             scales: {
//                 y: {
//                     beginAtZero: true,
//                     grid: {
//                         color: 'rgba(16, 185, 129, 0.1)'
//                     },
//                     ticks: {
//                         stepSize: 1,
//                         callback: function(value) {
//                             return Math.floor(value) + ' emp.';
//                         }
//                     }
//                 },
//                 x: {
//                     grid: {
//                         display: false
//                     }
//                 }
//             }
//         }
//     });
// }

        // Répartition par Sexe - CORRECTION POUR ÉVITER LES DOUBLONS
        function updateSexeDistributionChart() {
            const ctx = document.getElementById('sexeDistributionChart').getContext('2d');
            const uniqueEmployees = getUniqueEmployees(filteredData);
            
            const sexeCounts = {
                'Homme': 0,
                'Femme': 0,
                'Non spécifié': 0
            };
            
            uniqueEmployees.forEach(row => {
                const sexe = row['Sexe'] || 'Non spécifié';
                sexeCounts[sexe] = (sexeCounts[sexe] || 0) + 1;
            });

            if (charts.sexeDistribution) {
                charts.sexeDistribution.destroy();
            }

            charts.sexeDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(sexeCounts),
                    datasets: [{
                        data: Object.values(sexeCounts),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)', // Hommes
                            'rgba(255, 99, 132, 0.8)', // Femmes
                            'rgba(201, 203, 207, 0.8)' // Autres
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(201, 203, 207, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 62, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(102, 126, 234, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.chart.getDatasetMeta(0).total;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Répartition par Shift - CORRECTION POUR ÉVITER LES DOUBLONS
        function updateShiftDistributionChart() {
            const ctx = document.getElementById('shiftDistributionChart').getContext('2d');
            const uniqueEmployees = getUniqueEmployees(filteredData);
            
            const shiftCounts = {};
            
            uniqueEmployees.forEach(row => {
                const shift = row['Shift'] || 'Non spécifié';
                shiftCounts[shift] = (shiftCounts[shift] || 0) + 1;
            });

            const totalEmployees = uniqueEmployees.length; // ADD THIS LINE


            if (charts.shiftDistribution) {
                charts.shiftDistribution.destroy();
            }

            charts.shiftDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(shiftCounts),
                    datasets: [{
                        label: 'Nombre de personnes',
                        data: Object.values(shiftCounts),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 62, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(75, 192, 192, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = ((value / totalEmployees) * 100).toFixed(1);
                                    return `${value} employés (${percentage}%)`; // UPDATED THIS LINE
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 192, 192, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Répartition par Département - CORRECTION POUR ÉVITER LES DOUBLONS
        function updateDepartmentDistributionChart() {
            const ctx = document.getElementById('departmentDistributionChart').getContext('2d');
            const uniqueEmployees = getUniqueEmployees(filteredData);
            
            const deptCounts = {};
            
            uniqueEmployees.forEach(row => {
                const dept = row['Département'] || 'Non spécifié';
                deptCounts[dept] = (deptCounts[dept] || 0) + 1;
            });

            // Trier et prendre les 10 premiers départements
            const sortedDepts = Object.entries(deptCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

                    const totalEmployees = uniqueEmployees.length; // ADD THIS LINE

            if (charts.departmentDistribution) {
                charts.departmentDistribution.destroy();
            }

            charts.departmentDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDepts.map(d => d[0]),
                    datasets: [{
                        label: 'Nombre de personnes',
                        data: sortedDepts.map(d => d[1]),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 62, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(153, 102, 255, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const percentage = ((value / totalEmployees) * 100).toFixed(1);
                                    return `${value} employés (${percentage}%)`; // UPDATED THIS LINE
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(153, 102, 255, 0.1)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Nouvelle Répartition par Service
        function updateServiceDistributionChart() {
            const ctx = document.getElementById('serviceDistributionChart').getContext('2d');
            const uniqueEmployees = getUniqueEmployees(filteredData);
            
            const serviceCounts = {};
            
            uniqueEmployees.forEach(row => {
                const service = row['Service / Fonction'] || 'Non spécifié';
                serviceCounts[service] = (serviceCounts[service] || 0) + 1;
            });

            // Trier et prendre les 10 premiers services
            const sortedServices = Object.entries(serviceCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const totalEmployees = uniqueEmployees.length; // ADD THIS LINE


            if (charts.serviceDistribution) {
                charts.serviceDistribution.destroy();
            }

            charts.serviceDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedServices.map(s => s[0]),
                    datasets: [{
                        label: 'Nombre de personnes',
                        data: sortedServices.map(s => s[1]),
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 62, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 159, 64, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                            label: function(context) {
                                const value = context.parsed.x;
                                const percentage = ((value / totalEmployees) * 100).toFixed(1);
                                return `${value} employés (${percentage}%)`; // UPDATED THIS LINE
                            }
                        }
                    }
                },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 159, 64, 0.1)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Monthly Salary Chart
        function updateMonthlySalaryChart() {
            const ctx = document.getElementById('monthlySalaryChart').getContext('2d');
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            const monthlyData = months.map(month => {
                return filteredData.reduce((sum, row) => {
                    // Utiliser la fonction de nettoyage
                    const value = cleanNumericValue(row[month]);
                    return sum + value;
                }, 0);
            });

            if (charts.monthlySalary) {
                charts.monthlySalary.destroy();
            }

            charts.monthlySalary = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Salaires mensuels',
                        data: monthlyData,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        hoverBackgroundColor: 'rgba(102, 126, 234, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 62, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(102, 126, 234, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Salaire: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(102, 126, 234, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

// Department Salary Chart - UPDATED: Show total salary instead of average
function updateDepartmentSalaryChart() {
    const ctx = document.getElementById('departmentSalaryChart').getContext('2d');
    
    const deptSalary = {};
    
    filteredData.forEach(row => {
        const dept = row['Département'] || 'Non spécifié';
        if (!deptSalary[dept]) {
            deptSalary[dept] = 0;
        }
        // Sum total annual salaries by department
        deptSalary[dept] += (row._totalSalary || 0);
    });

    // Sort departments by total salary and take top 10
    const sortedDepts = Object.entries(deptSalary)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    if (charts.departmentSalary) {
        charts.departmentSalary.destroy();
    }

    charts.departmentSalary = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedDepts.map(d => d[0]),
            datasets: [{
                label: 'Salaire Total',
                data: sortedDepts.map(d => d[1]),
                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(59, 130, 246, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Salaire total: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(59, 130, 246, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Category Salary Chart - UPDATED: Show total salary instead of average
function updateCategorySalaryChart() {
    const ctx = document.getElementById('categorySalaryChart').getContext('2d');
    
    const categorySalary = {};
    
    filteredData.forEach(row => {
        const category = row['Catégorie'] || 'Non spécifié';
        if (!categorySalary[category]) {
            categorySalary[category] = 0;
        }
        // Sum total annual salaries by category
        categorySalary[category] += (row._totalSalary || 0);
    });

    if (charts.categorySalary) {
        charts.categorySalary.destroy();
    }

    const colors = [
        'rgba(147, 51, 234, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(251, 146, 60, 0.8)'
    ];

    charts.categorySalary = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(categorySalary),
            datasets: [{
                label: 'Salaire Total',
                data: Object.values(categorySalary),
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(147, 51, 234, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Salaire total: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(147, 51, 234, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Top Services Salary Chart - UPDATED: Show total salary instead of average
function updateTopServicesSalaryChart() {
    const ctx = document.getElementById('topServicesSalaryChart').getContext('2d');
    
    const serviceSalary = {};
    
    filteredData.forEach(row => {
        const service = row['Service / Fonction'] || 'Non spécifié';
        if (!serviceSalary[service]) {
            serviceSalary[service] = 0;
        }
        // Sum total annual salaries by service
        serviceSalary[service] += (row._totalSalary || 0);
    });

    // Sort services by total salary and take top 10
    const sortedServices = Object.entries(serviceSalary)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    if (charts.topServicesSalary) {
        charts.topServicesSalary.destroy();
    }

    charts.topServicesSalary = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedServices.map(s => s[0]),
            datasets: [{
                label: 'Salaire Total',
                data: sortedServices.map(s => s[1]),
                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(16, 185, 129, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Salaire total: ' + formatCurrency(context.parsed.x);
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(16, 185, 129, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

        // Salary Range Distribution - MODIFICATION DES TRANCHES
        // function updateSalaryRangeChart() {
        //     const ctx = document.getElementById('salaryRangeChart').getContext('2d');
        //     const uniqueEmployees = getUniqueEmployees(filteredData);
            
        //     // Définition des nouvelles tranches de salaire
        //     const ranges = [
        //         { min: 0, max: 3000, label: '< 3000' },
        //         { min: 3000, max: 5000, label: '3000 - 5000' },
        //         { min: 5000, max: 10000, label: '5000 - 10000' },
        //         { min: 10000, max: 15000, label: '10000 - 15000' },
        //         { min: 15000, max: 20000, label: '15000 - 20000' },
        //         { min: 20000, max: Infinity, label: '> 20000' }
        //     ];
            
        //     const rangeCounts = new Array(ranges.length).fill(0);
            
        //     filteredData.forEach(row => {
        //         const salary = row._totalSalary || 0;
        //         for (let i = 0; i < ranges.length; i++) {
        //             if (salary >= ranges[i].min && salary < ranges[i].max) {
        //                 rangeCounts[i]++;
        //                 break;
        //             }
        //         }
        //     });

        //     if (charts.salaryRange) {
        //         charts.salaryRange.destroy();
        //     }

        //     charts.salaryRange = new Chart(ctx, {
        //         type: 'pie',
        //         data: {
        //             labels: ranges.map(r => r.label),
        //             datasets: [{
        //                 data: rangeCounts,
        //                 backgroundColor: [
        //                     'rgba(239, 68, 68, 0.8)',
        //                     'rgba(245, 158, 11, 0.8)',
        //                     'rgba(34, 197, 94, 0.8)',
        //                     'rgba(59, 130, 246, 0.8)',
        //                     'rgba(139, 92, 246, 0.8)',
        //                     'rgba(236, 72, 153, 0.8)'
        //                 ],
        //                 borderColor: [
        //                     'rgba(239, 68, 68, 1)',
        //                     'rgba(245, 158, 11, 1)',
        //                     'rgba(34, 197, 94, 1)',
        //                     'rgba(59, 130, 246, 1)',
        //                     'rgba(139, 92, 246, 1)',
        //                     'rgba(236, 72, 153, 1)'
        //                 ],
        //                 borderWidth: 2
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             maintainAspectRatio: false,
        //             plugins: {
        //                 legend: {
        //                     position: 'bottom',
        //                     labels: {
        //                         padding: 20,
        //                         font: {
        //                             size: 12
        //                         }
        //                     }
        //                 },
        //                 tooltip: {
        //                     backgroundColor: 'rgba(26, 26, 62, 0.9)',
        //                     titleColor: '#fff',
        //                     bodyColor: '#fff',
        //                     borderColor: 'rgba(239, 68, 68, 0.5)',
        //                     borderWidth: 1,
        //                     padding: 12,
        //                     callbacks: {
        //                         label: function(context) {
        //                             const label = context.label || '';
        //                             const value = context.parsed;
        //                             const percentage = ((value / uniqueEmployees.length) * 100).toFixed(1);
        //                             return label + ': ' + value + ' (' + percentage + '%)';
        //                         }
        //                     }
        //                 }
        //             }
        //         }
        //     });
        // }


// Combined Annual Salary and Personnel Evolution Chart
function updateAnnualSalaryTrendChart() {
    const ctx = document.getElementById('annualSalaryTrendChart').getContext('2d');
    
    // Calculate salary data by year
    const yearlyData = {};
    filteredData.forEach(row => {
        const year = row['Année'] || 'Non spécifié';
        if (!yearlyData[year]) {
            yearlyData[year] = { total: 0, count: 0, uniqueEmployees: new Set() };
        }
        yearlyData[year].total += (row._totalSalary || 0);
        yearlyData[year].count += 1;
        
        // Track unique employees
        const employeeId = row._id || `${row['Matricule']}_${row['Nom & Prénom']}`;
        yearlyData[year].uniqueEmployees.add(employeeId);
    });

    // Sort years and prepare data
    const years = Object.keys(yearlyData).sort();
    const salaryData = years.map(year => yearlyData[year].total);
    const personnelData = years.map(year => yearlyData[year].uniqueEmployees.size);

    if (charts.annualSalaryTrend) {
        charts.annualSalaryTrend.destroy();
    }

    charts.annualSalaryTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                {
                    label: 'Masse Salariale Totale',
                    data: salaryData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#667eea',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'Nombre d\'Employés',
                    data: personnelData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#10b981',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBorderWidth: 2,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 26, 62, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(102, 126, 234, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return `Masse salariale: ${formatCurrency(context.parsed.y)}`;
                            } else {
                                return `Effectif: ${context.parsed.y} employés`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(102, 126, 234, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    },
                    title: {
                        display: true,
                        text: 'Masse Salariale (MAD)',
                        color: '#667eea',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true, // ADD/ENSURE THIS LINE
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        maxTicksLimit: 10, // Limit to maximum 10 ticks
                        callback: function(value) {
                            return Math.floor(value);
                        }
                    },
                    title: {
                        display: true,
                        text: 'Nombre d\'Employés',
                        color: '#10b981',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
}

        // Annual Salary Trend Chart - CORRECTION: calcul du salaire moyen mensuel
        // function updateAnnualSalaryTrendChart() {
        //     const ctx = document.getElementById('annualSalaryTrendChart').getContext('2d');
        //     const yearlyData = {};
            
        //     // Calcul des salaires moyens mensuels par année
        //     filteredData.forEach(row => {
        //         const year = row['Année'] || 'Non spécifié';
        //         if (!yearlyData[year]) {
        //             yearlyData[year] = { total: 0, count: 0 };
        //         }
        //         yearlyData[year].total += (row._totalSalary || 0); // Salaire mensuel moyen
        //         yearlyData[year].count += 1;
        //     });

        //     // Trier les années par ordre croissant
        //     const years = Object.keys(yearlyData).sort();
        //     const avgSalaries = years.map(year => 
        //         yearlyData[year].total
        //     );

        //     if (charts.annualSalaryTrend) {
        //         charts.annualSalaryTrend.destroy();
        //     }

        //     charts.annualSalaryTrend = new Chart(ctx, {
        //         type: 'line',
        //         data: {
        //             labels: years,
        //             datasets: [{
        //                 label: 'Salaire Total',
        //                 data: avgSalaries,
        //                 borderColor: '#667eea',
        //                 backgroundColor: 'rgba(102, 126, 234, 0.1)',
        //                 borderWidth: 3,
        //                 tension: 0.3,
        //                 fill: true,
        //                 pointBackgroundColor: '#fff',
        //                 pointRadius: 5,
        //                 pointHoverRadius: 7
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             maintainAspectRatio: false,
        //             plugins: {
        //                 legend: {
        //                     display: false
        //                 },
        //                 tooltip: {
        //                     backgroundColor: 'rgba(26, 26, 62, 0.9)',
        //                     titleColor: '#fff',
        //                     bodyColor: '#fff',
        //                     borderColor: 'rgba(102, 126, 234, 0.5)',
        //                     borderWidth: 1,
        //                     padding: 12,
        //                     callbacks: {
        //                         label: function(context) {
        //                             return 'Salaire mensuel moyen: ' + formatCurrency(context.parsed.y);
        //                         }
        //                     }
        //                 }
        //             },
        //             scales: {
        //                 y: {
        //                     beginAtZero: false,
        //                     grid: {
        //                         color: 'rgba(102, 126, 234, 0.1)'
        //                     },
        //                     ticks: {
        //                         callback: function(value) {
        //                             return formatCurrency(value);
        //                         }
        //                     }
        //                 },
        //                 x: {
        //                     grid: {
        //                         display: false
        //                     }
        //                 }
        //             }
        //         }
        //     });
        // }

        // Update data table
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            const searchBox = document.getElementById('searchBox');
            const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            
            let displayData = filteredData;
            
            // Apply search filter
            if (searchBox.value) {
                const searchTerm = searchBox.value.toLowerCase();
                displayData = displayData.filter(row => {
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Add new rows (limit to 100 for performance)
            displayData.slice(0, 20).forEach(row => {
                const tr = document.createElement('tr');
                
                // Création des cellules pour les informations de base
                tr.innerHTML = `
                    <td class="fixed-column">${row['Matricule'] || ''}</td>
                    <td class="fixed-column">${row['Nom & Prénom'] || ''}</td>
                    <td>${row['Société'] || ''}</td>
                    <td>${row['Département'] || ''}</td>
                    <td>${row['Catégorie'] || ''}</td>
                    <td>${row['Service / Fonction'] || ''}</td>
                    <td><span style="color: ${row['Shift'] === 'Jour' ? '#f39c12' : '#3498db'}">${row['Shift'] || ''}</span></td>
                `;
                
                // Ajout des salaires mensuels
                months.forEach(month => {
                    const value = cleanNumericValue(row[month]);
                    const td = document.createElement('td');
                    td.textContent = formatCurrency(value);
                    td.classList.add('month-column');
                    tr.appendChild(td);
                });
                
                // Ajout du total et de l'année
                const totalTd = document.createElement('td');
                totalTd.textContent = formatCurrency(row._totalSalary || 0);
                totalTd.classList.add('total-column');
                tr.appendChild(totalTd);
                
                const yearTd = document.createElement('td');
                yearTd.textContent = row['Année'] || '';
                yearTd.classList.add('year-column');
                tr.appendChild(yearTd);
                
                tableBody.appendChild(tr);
            });
            
            const uniqueEmployees = getUniqueEmployees(filteredData);


            // Show message if more than 100 rows
            if (displayData.length > 100) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 20; // Nombre de colonnes total
                td.textContent = `Affichage limité aux 20 premiers résultats (${uniqueEmployees.length} total)`;
                td.style.textAlign = 'center';
                td.style.padding = '20px';
                td.style.opacity = '0.7';
                tr.appendChild(td);
                tableBody.appendChild(tr);
            }
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', updateTable);

        // Utility function to format numbers as currency
        function formatCurrency(num) {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: 'MAD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(num);
        }

        // Add resize event listener for charts
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });

        // Export functionality for charts
        document.querySelectorAll('.chart-action').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartContainer = this.closest('.chart-container');
                const canvas = chartContainer.querySelector('canvas');
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'chart.png';
                link.href = url;
                link.click();
            });
        });

        // Debug function to log to the debug panel
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            const entry = document.createElement('div');
            entry.textContent = message;
            debugOutput.appendChild(entry);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // Initialize debug panel
        debugLog("Système initialisé. Prêt à charger un fichier Excel.");

    </script>
</body>
</html>
